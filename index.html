<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro IPTV Player v2.4 (English Version)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        :root {
            --bg-body: #0d1117;
            --sidebar-bg: #161b22;
            --list-item-bg: #21262d;
            --accent-color: #58a6ff;
            --text-main: #c9d1d9;
            --text-dim: #8b949e;
            --error-red: #ff7b72;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                height: 100%;
                transform: translateX(-100%);
            }
            .sidebar.active { transform: translateX(0); }
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid #30363d; }
        
        #countrySearch {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: var(--bg-body);
            color: white;
            outline: none;
        }

        #countryList { list-style: none; overflow-y: auto; flex-grow: 1; }
        #countryList li {
            padding: 14px 20px;
            cursor: pointer;
            border-bottom: 1px solid #21262d;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }
        #countryList li:hover { background: #30363d; }
        #countryList li.active { background: #1f6feb; color: white; font-weight: bold; }
        #countryList li.hidden { display: none !important; }

        /* Main Content area */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .header {
            padding: 15px 20px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle {
            display: none;
            background: var(--list-item-bg);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        @media (max-width: 768px) { .menu-toggle { display: block; } }

        #channelSearch {
            flex-grow: 1;
            padding: 12px 20px;
            border-radius: 25px;
            border: 1px solid #30363d;
            background: var(--bg-body);
            color: white;
            outline: none;
        }

        /* Channel Row Styling */
        .channel-list {
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .channel-row {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--list-item-bg);
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: 0.2s;
        }

        .channel-row:hover { background: #30363d; border-left: 4px solid var(--accent-color); }

        .avatar {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; margin-right: 15px; flex-shrink: 0;
        }

        .channel-info h4 { font-size: 1rem; margin-bottom: 3px; }
        .channel-info p { font-size: 0.8rem; color: var(--text-dim); }

        /* Video Modal & Error display */
        .modal {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.95);
            display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000;
        }

        .modal-content { width: 95%; max-width: 960px; position: relative; }
        #videoPlayer { width: 100%; border-radius: 8px; background: #000; aspect-ratio: 16/9; }

        .error-overlay {
            background: rgba(20, 20, 25, 0.95);
            color: var(--text-main);
            margin-top: 15px;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--error-red);
            text-align: center;
            display: none;
        }

        .stream-link-box {
            background: #000;
            padding: 12px;
            margin: 15px 0;
            border-radius: 6px;
            font-family: monospace;
            word-break: break-all;
            color: var(--accent-color);
            border: 1px dashed #444;
            font-size: 0.85rem;
        }

        .vlc-badge {
            background: #ff8800;
            color: black;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .close-btn {
            position: absolute; top: -50px; right: 0;
            font-size: 2.5rem; color: white; cursor: pointer;
        }

        #loader {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--accent-color);
            color: white;
            padding: 15px 30px; border-radius: 30px;
            z-index: 3000; display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .sidebar-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.5); z-index: 999;
        }
        .sidebar-overlay.active { display: block; }
    </style>
</head>
<body>

    <div id="loader">Syncing Channels...</div>
    <div class="sidebar-overlay" id="overlay"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 style="color: var(--accent-color); margin-bottom: 10px;">üåç Regions</h2>
            <input type="text" id="countrySearch" placeholder="Filter countries...">
        </div>
        <ul id="countryList">
            <li class="active" data-code="all" onclick="filterByCountry('all', this)">üåê Global Channels</li>
        </ul>
    </aside>

    <main class="main-content">
        <header class="header">
            <button class="menu-toggle" id="menuBtn">‚ò∞ Menu</button>
            <input type="text" id="channelSearch" placeholder="Search by channel name or category...">
        </header>

        <div id="channelList" class="channel-list"></div>
    </main>

    <div id="videoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeModal">&times;</span>
            <video id="videoPlayer" controls autoplay></video>
            <h3 id="nowPlaying" style="margin-top: 15px; text-align: center;">Channel Name</h3>
            
            <div id="errorMessage" class="error-overlay">
                <h4 style="color: var(--error-red); margin-bottom: 10px;">‚ö†Ô∏è Stream Unavailable in Browser</h4>
                <p>Browser security (CORS/Mixed Content) has blocked this stream from loading.</p>
                <div class="stream-link-box" id="failLink">URL loading...</div>
                <p>üí° <b>Solution:</b> Copy the link above and paste it into <span class="vlc-badge">VLC Media Player</span> using <b>"Open Network Stream"</b>.</p>
            </div>
        </div>
    </div>

    <script>
        let allChannels = [];
        let allStreams = [];
        let countries = [];
        let currentCountry = 'all';
        let hlsInstance = null;

        const API = {
            channels: 'https://iptv-org.github.io/api/channels.json',
            streams: 'https://iptv-org.github.io/api/streams.json',
            countries: 'https://iptv-org.github.io/api/countries.json'
        };

        const colors = ['#f28b82', '#fbbc04', '#fff475', '#ccff90', '#a7ffeb', '#aecbfa', '#d7aefb'];

        // Initial data fetch
        async function init() {
            toggleLoader(true);
            try {
                const [c, s, cn] = await Promise.all([
                    fetch(API.channels).then(r => r.json()),
                    fetch(API.streams).then(r => r.json()),
                    fetch(API.countries).then(r => r.json())
                ]);
                allChannels = c; allStreams = s; countries = cn;
                renderCountries(); renderChannels();
            } catch (e) { 
                console.error(e);
                alert("Failed to load data. Please check your connection."); 
            }
            toggleLoader(false);
        }

        // Sidebar Country Search Logic
        document.getElementById('countrySearch').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const items = document.querySelectorAll('#countryList li');
            items.forEach(li => {
                const name = li.innerText.toLowerCase();
                li.classList.toggle('hidden', !name.includes(term));
            });
        });

        // Render Countries in Sidebar
        function renderCountries() {
            const list = document.getElementById('countryList');
            countries.sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${c.flag || 'üè≥Ô∏è'}</span> ${c.name}`;
                li.onclick = () => { 
                    filterByCountry(c.code, li); 
                    if(window.innerWidth <= 768) toggleSidebar(); 
                };
                list.appendChild(li);
            });
        }

        // Render Channels in Main Grid
        function renderChannels(query = '') {
            const container = document.getElementById('channelList');
            container.innerHTML = '';
            const streamMap = new Map(allStreams.map(s => [s.channel, s]));

            const filtered = allChannels.filter(ch => {
                const matchesCountry = currentCountry === 'all' || ch.country === currentCountry;
                const matchesSearch = ch.name.toLowerCase().includes(query.toLowerCase());
                return matchesCountry && matchesSearch && streamMap.has(ch.id);
            }).slice(0, 150);

            if (filtered.length === 0) {
                container.innerHTML = `<p style="text-align:center; padding:20px; color:var(--text-dim)">No channels found.</p>`;
                return;
            }

            filtered.forEach(ch => {
                const stream = streamMap.get(ch.id);
                const row = document.createElement('div');
                row.className = 'channel-row';
                row.innerHTML = `
                    <div class="avatar" style="background:${colors[ch.name.length % colors.length]}">${ch.name[0]}</div>
                    <div class="channel-info">
                        <h4>${ch.name}</h4>
                        <p>${ch.categories[0] || 'General'} ‚Ä¢ ${ch.country}</p>
                    </div>
                `;
                row.onclick = () => playStream(stream.url, ch.name);
                container.appendChild(row);
            });
        }

        // Main Streaming Logic
        function playStream(url, name) {
            const modal = document.getElementById('videoModal');
            const video = document.getElementById('videoPlayer');
            const errorMsg = document.getElementById('errorMessage');
            const linkBox = document.getElementById('failLink');
            
            errorMsg.style.display = 'none';
            video.style.display = 'block';
            linkBox.innerText = url;
            document.getElementById('nowPlaying').innerText = name;
            modal.style.display = 'flex';

            // Automatic proxy for Mixed Content (HTTPS -> HTTP)
            let finalUrl = url;
            if (window.location.protocol === 'https:' && url.startsWith('http://')) {
                finalUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                console.log("Using CORS Proxy for HTTP stream");
            }

            if (hlsInstance) hlsInstance.destroy();

            if (Hls.isSupported()) {
                hlsInstance = new Hls({ 
                    manifestLoadingTimeOut: 20000,
                    fragLoadingMaxRetry: 8,
                    fragLoadingRetryDelay: 2000,
                    enableWorker: true
                });
                
                hlsInstance.loadSource(finalUrl);
                hlsInstance.attachMedia(video);

                hlsInstance.on(Hls.Events.ERROR, function (event, data) {
                    if (data.details === Hls.ErrorDetails.FRAG_LOAD_ERROR) {
                        console.warn("Retrying Fragment load...");
                        hlsInstance.startLoad();
                    }
                    if (data.fatal) {
                        errorMsg.style.display = 'block';
                        video.style.display = 'none';
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = finalUrl;
                video.onerror = () => {
                    errorMsg.style.display = 'block';
                    video.style.display = 'none';
                };
            }
        }

        // Toggle mobile sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        // Filter by country code
        function filterByCountry(code, el) {
            currentCountry = code;
            document.querySelectorAll('#countryList li').forEach(li => li.classList.remove('active'));
            el.classList.add('active');
            renderChannels();
        }

        // Event listeners
        document.getElementById('menuBtn').onclick = toggleSidebar;
        document.getElementById('overlay').onclick = toggleSidebar;
        document.getElementById('channelSearch').oninput = (e) => renderChannels(e.target.value);
        
        document.getElementById('closeModal').onclick = () => {
            document.getElementById('videoPlayer').pause();
            document.getElementById('videoPlayer').src = "";
            if(hlsInstance) hlsInstance.destroy();
            document.getElementById('videoModal').style.display = 'none';
        };

        function toggleLoader(show) { 
            document.getElementById('loader').style.display = show ? 'block' : 'none'; 
        }

        // Start the application
        init();
    </script>
</body>
</html>
